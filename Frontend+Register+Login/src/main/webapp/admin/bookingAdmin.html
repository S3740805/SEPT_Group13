<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <style>
        /* Style sheet */
        body {
            padding-top: 3.5rem;
        }

        #delete{
            color: cornflowerblue;
        }
        #delete:hover {
            color: cornflowerblue;
            cursor: pointer;
            text-decoration: underline;
        }
        #delete:active{
            color: red;
            cursor: pointer;
        }
    </style>
    <title>All bookings</title>
</head>
<body>

<div class="container-fluid">
    <div class="container" >
        <!--        Heading-->
        <h1 style="text-align: center" >All appointments</h1>
        <!--        Table for bookings-->
        <table class="table">
            <thead>
            <tr>
                <th>Appointment Number</th>
                <th>Patient username</th>
                <th>With doctor</th>
                <th>Time</th>
                <th>Date</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="allBookings">
            </tbody>
        </table>
    </div>

</div>
</body>
<script>
    let doctors = []
    // function to run onload
    document.addEventListener('DOMContentLoaded', function () {
        sessionStorage.setItem("state","admin") //IMPORTANT: Set state to develop code
        getBookings();
    })
    // This is function to delete a booking
    function cancelBooking(id){
        if (confirm("Delete this appointment?")){
            fetch(`http://localhost:8080/bookings/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(res => {alert("Delete success.")}).then(res =>{location.reload()})
        }
    }
    // This is get booking function
    function getBookings(){
        // let state = sessionStorage.getItem("state")
        let allBookings = document.getElementById("allBookings")
        fetch(`http://localhost:8080/doctors`).then(res =>  res.json()) // This is fetching doctors
            .then(json=>{
                json.sort((a,b) => {
                    (parseInt(a.id) > parseInt(b.id)) ? 1 : -1
                })
                for (let i = 0; i < json.length ; i++) {
                    let obj = {id : json[i].id, name : json[i].name}
                    doctors.push(obj)
                }
                // This is fetching bookings from the user
            }).then (fetch(`http://localhost:8080/bookings`).then(res => res.json())
            .then(json => {
                // This sort the JSON by date, from most recently
                json.sort((a,b)=>{
                    if (new Date(parseInt(a.date.split("-")[0]),
                        parseInt(a.date.split("-")[1]) -1 ,
                        parseInt(a.date.split("-")[2]),
                        parseInt(a.time.split(":")[0]),
                        parseInt(a.time.split(":")[1])) >
                        new Date(parseInt(b.date.split("-")[0]),
                            parseInt(b.date.split("-")[1]) -1 ,
                            parseInt(b.date.split("-")[2]),
                            parseInt(b.time.split(":")[0]),
                            parseInt(b.time.split(":")[1])))
                        return -1
                    else return 1
                })
                for (let i = 0; i < json.length ; i++) {
                    console.log(json[i])
                    let id = json[i].id
                    let cancel = `<div id="delete" onclick='cancelBooking(${id})'>Delete</div>`
                    let doctorName = ""
                    doctors.forEach(doc => {if(doc.id === json[i].doctor_id) doctorName = doc.name})
                    allBookings.innerHTML += '<tr id="bookings">'+
                        '<td>' + json[i].id + '</td>' +
                        '<td>' + json[i].userName + '</td>' +
                        '<td>' + doctorName + '</td>' +
                        '<td>' + json[i].time + '</td>' +
                        '<td>' + json[i].date + '</td>' +
                        '<td>' + cancel + '</td>' +
                        '</tr>'
                }
            }))
    }
</script>
</html>